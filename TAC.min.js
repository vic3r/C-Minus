var TAC=function(a){function q(a){return!isNaN(parseFloat(a))&&isFinite(a)}function r(a){return"undefined"!=typeof c[a]}function s(a){return"object"==typeof d[a]}function t(a){return!!a.match(/\[.*\]/)&&"object"==typeof c[a.substr(0,a.indexOf("["))]}function u(a,b){return"undefined"!=typeof b&&1!=b?r(a)&&u(v(a),b-1):!(!r(a)||!r(v(a)))}var h,i,b=[],c={},d={},e={},f=[],g=[],j={};j.var="[a-zA-Z][a-zA-Z0-9]*(\\[([0-9]+|[a-zA-Z][a-zA-Z0-9]*)\\])?",j.constant="[0-9]+",j.op="[\\*\\-\\+\\/\\&\\=\\<\\!\\>\\%]+",j.goto="(\\s+)?goto(\\s+)("+j.var+")(\\s+)?",j.exp="(\\s+)?(((("+j.var+")|("+j.constant+"))?(\\s+)?("+j.op+")(\\s+)?(("+j.var+")|("+j.constant+")))|("+j.var+")|("+j.constant+"))",j.method="(\\s+)?call\\s+("+j.var+")(\\s+)?,(\\s+)?("+j.exp+")(\\s+)?",j.return="(\\s+)?return(\\s+("+j.exp+"))?(\\s+)?",j.print="(\\s+)?print\\s+("+j.exp+")(\\s+)?",j.if="(\\s+)?if\\s+("+j.exp+")\\s+(("+j.exp+")|("+j.goto+")|("+j.return+")|("+j.print+"))(\\s+)?",j.param="(\\s+)?param\\s+("+j.exp+")(\\s+)?",j.def_method="(\\s+)?BeginFunc\\s+("+j.var+")(\\s+)?,(\\s+)?("+j.constant+")(\\s+)?",j.end_method="(\\s+)?EndFunc(\\s+)?";var k=!1,l="root",n=!1,o=!1,p="\n";"object"==typeof a&&("undefined"!=typeof a.debug&&(n=a.debug),"undefined"!=typeof a.stopOnError&&(o=a.stopOnError),"undefined"!=typeof a.separater&&(p=a.separater)),this.run=function(a,d,e,f){if(c={},"function"==typeof e&&(h=e),"function"==typeof f&&(i=f),"string"==typeof a&&a.length>0&&(a=a.split(p),b=a),"object"==typeof d&&d.length>0)for(key in d)c["p"+key]=d[key];return b.length>0&&z()},this.run_line=function(a,d,e,f,g){if(g&&(c={}),"function"==typeof e&&(h=e),"function"==typeof f&&(i=f),"string"==typeof a&&a.length>0&&(b=[],b.push(a)),"object"==typeof d&&d.length>0)for(key in d)c["p"+key]=d[key];return b.length>0&&z()},this.add=function(a){b.push(a)},this.get=function(a){return w(a)},this.output=function(){return g},this.debug=function(){return!!n&&c};var v=function(a){if(a=a.replace(/\s+/,""),0==a.length)throw{message:"Missing Operand",code:101};if(q(a))return parseFloat(a);if(r(a))return c[a];if(t(a)){var b=w(a.substr(a.indexOf("[")+1,a.indexOf("]")-1-a.indexOf("["))),d=c[a.substr(0,a.indexOf("["))];if("undefined"!=typeof d[parseFloat(b)])return d[parseFloat(b)];throw{message:"Array index out of bound '"+a+"'",code:108}}throw{message:"Unknown variable '"+a+"'",code:100}},w=function(a){if(a=a.replace(/\s+/g,""),!a.match(j.op))return v(a);var b=a.match(j.op)[0],c=a.split(b);if(0==c[0].replace(/\s+/,"").length&&c[1].replace(/\s+/,"").length>0){switch(b){case"-":return-v(c[1]);case"*":if(u(c[1],1))return v(v(c[1]));break;case"&":if(r(c[1]))return c[1];break;case"**":if(u(c[1],2))return v(v(v(c[1])))}throw{message:"Unknown operator '"+b+"'",code:102}}try{switch(b){case"+":return v(c[0])+v(c[1]);case"-":return v(c[0])-v(c[1]);case"*":return v(c[0])*v(c[1]);case"/":return v(c[0])/v(c[1]);case"%":return v(c[0])%v(c[1]);case"==":return v(c[0])==v(c[1]);case"<":return v(c[0])<v(c[1]);case">":return v(c[0])>v(c[1]);case"!=":return v(c[0])!=v(c[1]);case"<=":return v(c[0])<=v(c[1]);case">=":return v(c[0])>=v(c[1])}throw{message:"Unknown operator '"+b+"'",code:102}}catch(a){throw a}},x=function(a,b){if(0==a.indexOf("*")){var d=(a.match(/\*/g)||[]).length;if(!(d<=2&&u(a.substr(d),d)))throw{message:"Invalid Pointer Reference '"+a+"'",code:104};a=a.substr(d),1==d?c[c[a]]=b:c[c[c[a]]]=b}else if(a.match(/\[.*\]/))if(t(a))c[a.substr(0,a.indexOf("["))][a.substr(a.indexOf("[")+1,a.indexOf("]")-1-a.indexOf("["))]=b;else{if(r(a.substr(0,a.indexOf("["))))throw{message:"Invalid Type Conversion - cannot convert integer '"+a+"' to array",code:105};c[a.substr(0,a.indexOf("["))]={},c[a.substr(0,a.indexOf("["))][a.substr(a.indexOf("[")+1,a.indexOf("]")-1-a.indexOf("["))]=b}else c[a]=b},y=function(a,b){if(k)return a.match(j.end_method)?(k=!1,l=""):d[l].compiler.add(a),!1;if(a.indexOf(":")!=-1){if(a.length<=a.indexOf(":")+1)return!1;a=a.substr(a.indexOf(":")+1)}if(0==a.replace(/\s+/g,"").length)return!1;if(a.match(j.if)){var g=a.match(j.if)[2],i=w(g);if(i){var m=a.substr(a.indexOf(g)+g.length);y(m,b)}}else{if(a.match(j.print)){var g=a.match(j.print)[2],i=w(g);throw{print:i}}if(a.match(j.return)){var g=a.match(j.return)[2];if("undefined"!=typeof g){var i=w(g);throw{return:i}}throw{return:""}}if(a.match(j.goto)){var n=a.match(j.goto)[3];throw"undefined"!=typeof e[n]?{label:e[n]}:{message:"Undefined Label '"+n+"'",code:106}}if(a.match(j.method)){var o=a.match(j.method),p=o[2],q=o[7];if(!(s(p)&&f.length>=q))throw{message:"Invalid Method call '"+p+"' with "+q+" params",code:107};attribs=f.slice(0,q),f=f.slice(q);var r=d[p].compiler.run("",attribs,h);"undefined"!=typeof r&&(c.out=r)}else if(a.match(j.param)){var g=a.match(j.param)[2];f.push(w(g))}else if(a.match(j.def_method)){var o=a.match(j.def_method),p=o[2],q=o[5];d[p]={},d[p].compiler=new TAC,d[p].paramlength=q,d[p].params=[],k=!0,l=p}else if(a.match(j.exp)){if(a=a.replace(/\s+/g,""),vars=a.split("="),!(vars.length>1)){var i=w(a);throw{print:i}}x(vars[0],w(vars[1]))}}return!0},z=function(){for(var a in b){var c=b[a];c.indexOf(":")!=-1&&(e[c.substr(0,c.indexOf(":")).replace(/\s+/,"")]=parseInt(a))}for(var a=0;a<b.length;){var c=b[a];try{y(c,a)}catch(b){if("object"==typeof b&&"undefined"!=typeof b.label)a=b.label-1;else{if("object"==typeof b&&"undefined"!=typeof b.return)return b.return;if("object"==typeof b&&"undefined"!=typeof b.print)g.push({val:b.print,line:a+1}),"function"==typeof h&&h({val:b.print,line:a+1});else if("object"==typeof b?(b.message+=" in line "+(a+1),b.line=a+1):b={message:b,line:a+1,code:120},"function"==typeof i&&i(b),n&&console.error(b),o)return}}a++}return!0}};
